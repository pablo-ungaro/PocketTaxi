package br.com.pockettaxi.server.resources;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.TimeUnit;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;

import br.com.pockettaxi.model.Client;
import br.com.pockettaxi.model.Taxi;
import br.com.pockettaxi.model.Race;
import br.com.pockettaxi.server.model.ClientInQueue;
import br.com.pockettaxi.server.model.ModelAdapter;
import br.com.pockettaxi.server.model.TaxiLocation;

import com.sun.jersey.spi.resource.Singleton;

@Path("/taxi")
@Singleton
public class TaxiRequestResource {
	private BlockingQueue<Client> clients = new LinkedBlockingQueue<Client>();
	private BlockingQueue<Taxi> taxistas = new LinkedBlockingQueue<Taxi>();
	private Map<Long, Race> racing = new HashMap<Long, Race>();
	private static final long TIMEOUT = 60L;
	private static long count;
	private int indice = 0;

	public TaxiRequestResource() {
		Taxi taxi = new Taxi(2L, "Fabricio", 45L, -22.89326153817288,
				-43.12362680382098);
		taxistas.add(taxi);
	}

	@GET
	@Produces(MediaType.APPLICATION_JSON)
	@Path("/request")
	public ModelAdapter taxiRequest(@QueryParam("latitude") Double latitude,
			@QueryParam("longitude") Double longitude,
			@QueryParam("address") String address) {
		try {
			System.out.println("Cliente solicitou um taxi...");
			Client client = new Client(1L, "Fabio");
			client.setLongitude(longitude);
			client.setLatitude(latitude);
			client.setAddress(address);

			clients.put(client);

			Taxi taxi = taxistas.poll(TIMEOUT, TimeUnit.SECONDS);

			if (taxi != null) {
				ModelAdapter resp = new ModelAdapter();
				Race req = new Race();

				req.setClient(clients.take());
				req.setTaxi(taxi);
				resp.setRequest(req);

				return resp;
			}
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		return null;
	}

	@GET
	@Produces(MediaType.APPLICATION_JSON)
	@Path("/{id}/location")
	public TaxiLocation getActualPosition(@PathParam("id") Long taxiId) {
		System.out
				.println("Enviando localização atual do taxista para o cliente");
		return getProximoPonto();
	}

	@GET
	@Produces(MediaType.APPLICATION_JSON)
	@Path("/hasClient")
	public ClientInQueue getClientInQueue() {
		System.out.println("Enviando informações do cliente para o taxista");
		ClientInQueue cq = new ClientInQueue();
		cq.setClient(clients.peek());
		return cq;
	}

	@GET
	@Produces(MediaType.APPLICATION_JSON)
	@Path("/accept/client")
	public String acceptClient() {
		try {
			System.out.println("Taxista aceitou a corrida");
			Taxi taxi = taxistas.take();

			Client client = clients.peek();
			Race race = new Race(count++, taxi, client);
			
			racing.put(race.getId(), race);
			
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		return "OK";
	}

	private TaxiLocation getProximoPonto() {
		double latitude = (coordenadas[indice][1]);
		double longitude = (coordenadas[indice][0]);

		TaxiLocation p = new TaxiLocation(latitude, longitude);
		indice++;
		if (indice == coordenadas.length) {
			indice = 0;
		}
		return p;
	}

	public static double[][] coordenadas = new double[][] {
			// longitude //latitude
			{ -43.12362680382098, -22.89326153817288, 0 },
			{ -43.12362285940266, -22.89325312048009, 0 },
			{ -43.12361685917349, -22.89324249643892, 0 },
			{ -43.12361281998202, -22.89323825610821, 0 },
			{ -43.12361685935763, -22.89317318560888, 0 },
			{ -43.12362096481578, -22.89316182491254, 0 },
			{ -43.12362513347773, -22.89315028936272, 0 },
			{ -43.12362519603457, -22.89313871628191, 0 },
			{ -43.12362527231326, -22.89312459575907, 0 },
			{ -43.12362533696029, -22.89311262977451, 0 },
			{ -43.12362541703482, -22.89309792364163, 0 },
			{ -43.12362547226333, -22.89308787748235, 0 },
			{ -43.12362554231781, -22.89307513609025, 0 },
			{ -43.12362559918999, -22.89306479281509, 0 },
			{ -43.12362345680971, -22.89305439819899, 0 },
			{ -43.12362128644655, -22.89304386792946, 0 },
			{ -43.12361909137292, -22.89303048814662, 0 },
			{ -43.12361910640164, -22.89301955184363, 0 },
			{ -43.12361685976639, -22.89300855981011, 0 },
			{ -43.12361685980917, -22.89299165127673, 0 },
			{ -43.12361685984566, -22.89297449706801, 0 },
			{ -43.12361453620699, -22.89296306066147, 0 },
			{ -43.12361217351427, -22.89294853481936, 0 },
			{ -43.12361213353689, -22.89293370362186, 0 },
			{ -43.12361209281423, -22.89291861679822, 0 },
			{ -43.12361206806217, -22.89290943922289, 0 },
			{ -43.12361444717753, -22.89289699023916, 0 },
			{ -43.12361442170443, -22.89287808154365, 0 },
			{ -43.12361440005829, -22.8928620160193, 0 },
			{ -43.12360937454034, -22.89283584656922, 0 },
			{ -43.12360680749574, -22.89282247927447, 0 },
			{ -43.12360415677918, -22.89280202710287, 0 },
			{ -43.12360150435418, -22.89278816640258, 0 },
			{ -43.12360141866662, -22.89277758011557, 0 },
			{ -43.12359600400721, -22.89275263361079, 0 },
			{ -43.12359313390952, -22.89273078141548, 0 },
			{ -43.12359277151869, -22.89270075982646, 0 },
			{ -43.12359258611971, -22.89268540238996, 0 },
			{ -43.12359239784519, -22.89266980667687, 0 },
			{ -43.12359494434153, -22.89265387806178, 0 },
			{ -43.12359477168832, -22.89263778694279, 0 },
			{ -43.12359726110684, -22.89260891422823, 0 },
			{ -43.12359992445957, -22.89259200664737, 0 },
			{ -43.1236025443004, -22.89256182229835, 0 },
			{ -43.12360528855516, -22.89253969556594, 0 },
			{ -43.12361102567583, -22.89252153344063, 0 },
			{ -43.12361686102726, -22.89249381387344, 0 },
			{ -43.123622809723, -22.89247957503429, 0 },
			{ -43.12363186374827, -22.89246026028656, 0 },
			{ -43.1236319282986, -22.89245064695878, 0 },
			{ -43.12364128985831, -22.89242094797963, 0 },
			{ -43.12364452661377, -22.89240586015882, 0 },
			{ -43.12364801318586, -22.89237519831459, 0 },
			{ -43.12365143878478, -22.89235425301415, 0 },
			{ -43.12365167306145, -22.89233839109942, 0 },
			{ -43.12365553988973, -22.89229488609818, 0 },
			{ -43.12365626492798, -22.8922498855357, 0 },
			{ -43.12365645045787, -22.89223837058658, 0 },
			{ -43.12365711378492, -22.89219720015004, 0 },
			{ -43.12365429359858, -22.89216095406877, 0 },
			{ -43.12365850942105, -22.8921105774088, 0 },
			{ -43.12365871672858, -22.89209771002112, 0 },
			{ -43.12367012367546, -22.89205112429195, 0 },
			{ -43.12368144946049, -22.89202351178019, 0 },
			{ -43.12369665079941, -22.89199512762848, 0 },
			{ -43.12371293648587, -22.8919445355542, 0 },
			{ -43.12372954552724, -22.89189951258769, 0 },
			{ -43.12373904779466, -22.89185339590375, 0 },
			{ -43.12374039405045, -22.89182207869618, 0 },
			{ -43.12374960547964, -22.89178962449924, 0 },
			{ -43.12375902855625, -22.89175642465625, 0 },
			{ -43.12376650825821, -22.8916863235895, 0 },
			{ -43.12376926257165, -22.89163159511508, 0 },
			{ -43.12376557383151, -22.89162266621053, 0 },
			{ -43.12376506450294, -22.89154644300849, 0 },
			{ -43.12376792276154, -22.89148639819733, 0 },
			{ -43.12376549050305, -22.89144550951729, 0 },
			{ -43.12376347853377, -22.89139278293316, 0 },
			{ -43.12376632293472, -22.89132871343677, 0 },
			{ -43.12376462298723, -22.89126277508007, 0 },
			{ -43.12376659040616, -22.89121703132502, 0 },
			{ -43.12377815792265, -22.89116901306644, 0 },
			{ -43.12379064606728, -22.89110735225831, 0 },
			{ -43.12380375020762, -22.89104095113126, 0 },
			{ -43.12381664505258, -22.89098523351235, 0 },
			{ -43.12381739595374, -22.89097144255378, 0 },
			{ -43.12383853762416, -22.8906576378177, 0 },
			{ -43.12386871501008, -22.89044841771148, 0 },
			{ -43.12388009668125, -22.89051179618377, 0 },
			{ -43.12389442012545, -22.89050964599588, 0 },
			{ -43.12391232261135, -22.89045961512774, 0 },
			{ -43.12392685949436, -22.89039565202876, 0 },
			{ -43.1239408690864, -22.89034261862382, 0 },
			{ -43.12394739794887, -22.89026127039591, 0 },
			{ -43.12396107843227, -22.89021837316131, 0 },
			{ -43.12397109368082, -22.8901603281409, 0 },
			{ -43.12399206567169, -22.89009955377642, 0 },
			{ -43.12399611878726, -22.89005372265025, 0 },
			{ -43.12402235340128, -22.88987599961955, 0 },
			{ -43.12404305220724, -22.88978225778057, 0 },
			{ -43.12405192160176, -22.88975783946948, 0 },
			{ -43.12405555063201, -22.88975028337182, 0 },
			{ -43.1240556164023, -22.88974276756354, 0 },
			{ -43.12405581866201, -22.889719658166, 0 },
			{ -43.12405593433418, -22.88970644229138, 0 },
			{ -43.1240559812726, -22.8897010779421, 0 },
			{ -43.12405807031377, -22.88967908321423, 0 },
			{ -43.12406201291745, -22.88966771006211, 0 },
			{ -43.12406606975782, -22.88965333157835, 0 },
			{ -43.12406821113672, -22.88964153438156, 0 },
			{ -43.12407044841348, -22.88962650898507, 0 },
			{ -43.12407062134088, -22.88961739265792, 0 },
			{ -43.12407480373677, -22.88960793977837, 0 },
			{ -43.12407928114073, -22.88958885016561, 0 },
			{ -43.12408156723588, -22.88957910330242, 0 },
			{ -43.1240840686253, -22.88956262630681, 0 },
			{ -43.12408662619213, -22.8895458369899, 0 },
			{ -43.12409103141565, -22.88953895121793, 0 },
			{ -43.12409621527343, -22.88951098224701, 0 },
			{ -43.12410104943402, -22.88949654270693, 0 },
			{ -43.1241061312878, -22.8894781100299, 0 },
			{ -43.12411184531375, -22.88944769904174, 0 },
			{ -43.12411461211446, -22.88943596248714, 0 },
			{ -43.12412047060409, -22.88940788024362, 0 },
			{ -43.12412569289017, -22.88939547121091, 0 },
			{ -43.12412654659389, -22.88937875551572, 0 },
			{ -43.12413762099489, -22.88934842013899, 0 },
			{ -43.12414371664092, -22.88932612796088, 0 },
			{ -43.12415513410938, -22.88929905604277, 0 },
			{ -43.12416098333772, -22.88928518696079, 0 },
			{ -43.12416692931198, -22.88927108843087, 0 },
			{ -43.12417912132796, -22.88924217999764, 0 },
			{ -43.12419431581323, -22.88921221775087, 0 },
			{ -43.12420125091537, -22.88919175357272, 0 },
			{ -43.12421462012482, -22.88916008983029, 0 },
			{ -43.12421879670944, -22.88914390662653, 0 },
			{ -43.12422737515946, -22.88911066733736, 0 },
			{ -43.12423234483156, -22.88908786101874, 0 },
			{ -43.12423861939794, -22.88905263596075, 0 },
			{ -43.12424350042393, -22.88900370478965, 0 },
			{ -43.12424603431942, -22.88897830325521, 0 },
			{ -43.12425062764365, -22.88893225606156, 0 },
			{ -43.12425499376283, -22.88891861856008, 0 },
			{ -43.12426302351276, -22.88886967512638, 0 },
			{ -43.12426599622556, -22.88884071453926, 0 },
			{ -43.12427396799664, -22.88879444982803, 0 },
			{ -43.12428062288721, -22.8887619688236, 0 },
			{ -43.12429079190884, -22.88872826736488, 0 },
			{ -43.12430563913171, -22.88868453879597, 0 },
			{ -43.12431760947906, -22.88863946345979, 0 },
			{ -43.12432404206031, -22.88861349928454, 0 },
			{ -43.1243362651051, -22.88856885441225, 0 },
			{ -43.12434557654053, -22.88855021586522, 0 },
			{ -43.12435713652388, -22.88852100100821, 0 },
			{ -43.12436004327662, -22.8885108425034, 0 },
			{ -43.12435978487461, -22.88850266482645, 0 },
			{ -43.124362824315, -22.88849426223647, 0 },
			{ -43.12436585427653, -22.88848360924835, 0 },
			{ -43.12436894124716, -22.88847275574272, 0 },
			{ -43.12437544704193, -22.88845936657557, 0 },
			{ -43.12438380533009, -22.88844332948877, 0 },
			{ -43.12438545289421, -22.8884340800023, 0 },
			{ -43.12438889360403, -22.8884269710142, 0 },
			{ -43.12439947236866, -22.88840269585071, 0 },
			{ -43.12439947937943, -22.88840025392925, 0 },
			{ -43.12440679362007, -22.88838261501846, 0 },
			{ -43.12441057393612, -22.88836976370695, 0 },
			{ -43.12441439492944, -22.88835926284855, 0 },
			{ -43.12441832575471, -22.88834592585836, 0 },
			{ -43.12442239443058, -22.88832957973518, 0 },
			{ -43.12442669687803, -22.88830718369016, 0 },
			{ -43.12443084854593, -22.88829561476098, 0 },
			{ -43.12443114893473, -22.88828400874875, 0 },
			{ -43.12443558494469, -22.88826604868294, 0 },
			{ -43.1244401402056, -22.88824760590202, 0 },
			{ -43.12444526118096, -22.88821586682456, 0 },
			{ -43.12444779168917, -22.88820274338715, 0 },
			{ -43.12445286301269, -22.88817916081096, 0 },
			{ -43.12445609392773, -22.88815137866191, 0 },
			{ -43.12445869484408, -22.8881406194963, 0 },
			{ -43.12446621604312, -22.88811851593653, 0 },
			{ -43.12446912768806, -22.88810352727791, 0 },
			{ -43.12447434710509, -22.88808812360169, 0 },
			{ -43.12447760229325, -22.88806860839587, 0 },
			{ -43.1244834695452, -22.88804443284614, 0 },
			{ -43.12448904189548, -22.88802781229493, 0 },
			{ -43.12449288504072, -22.88800228896836, 0 },
			{ -43.12449900656249, -22.88798007926285, 0 },
			{ -43.12450804484703, -22.88795255821673, 0 },
			{ -43.12451233827083, -22.88792507976859, 0 },
			{ -43.12451864196219, -22.88790601890157, 0 },
			{ -43.12452544157571, -22.88788168267313, 0 },
			{ -43.12452651615464, -22.88786698068236, 0 },
			{ -43.12452871967291, -22.88783683266368, 0 },
			{ -43.12453593982221, -22.88781050867381, 0 },
			{ -43.12453983619616, -22.88779438487421, 0 },
			{ -43.12454151234483, -22.88777272908285, 0 },
			{ -43.12454598030966, -22.88775034029628, 0 },
			{ -43.12455101878715, -22.88772164857876, 0 },
			{ -43.12454848925262, -22.88770300667376, 0 },
			{ -43.12454900654232, -22.88769476495608, 0 },
			{ -43.12455136393878, -22.88768968982677, 0 },
			{ -43.12455154300341, -22.88767782391727, 0 },
			{ -43.12455377051282, -22.88767084914961, 0 },
			{ -43.12455681009128, -22.88765666340679, 0 },
			{ -43.12455778208744, -22.88765124991487, 0 },
			{ -43.12455858518924, -22.88764396264876, 0 },
			{ -43.12456022496348, -22.88762908397228, 0 },
			{ -43.12456383007208, -22.88761756537678, 0 },
			{ -43.12456751303552, -22.88760579802329, 0 },
			{ -43.12456790907012, -22.88759189558813, 0 },
			{ -43.1245688308214, -22.88758376753744, 0 },
			{ -43.12457139037347, -22.88757545773746, 0 },
			{ -43.12457678499057, -22.88756058331082, 0 },
			{ -43.12457614030592, -22.88755205898865, 0 },
			{ -43.12457898638431, -22.88754544756944, 0 },
			{ -43.12458432808311, -22.88752529176091, 0 },
			{ -43.12459014267733, -22.8875090600721, 0 },
			{ -43.12459317879384, -22.88750194481284, 0 },
			{ -43.12459572066884, -22.88748521506098, 0 },
			{ -43.12460049378208, -22.8874752987738, 0 },
			{ -43.12460522828085, -22.8874627347278, 0 },
			{ -43.12461006053042, -22.88744991123241, 0 },
			{ -43.12461176409104, -22.88744728105534, 0 },
			{ -43.12461479267367, -22.88743161131871, 0 },
			{ -43.12461975652651, -22.88741545852317, 0 },
			{ -43.12462313616608, -22.88740446079366, 0 },
			{ -43.12462823881006, -22.88738480514845, 0 },
			{ -43.12463163370882, -22.88736753629555, 0 },
			{ -43.12463707391937, -22.88734970999252, 0 },
			{ -43.12464073006422, -22.88733454080408, 0 },
			{ -43.12464642999128, -22.88731581996229, 0 },
			{ -43.12465038020362, -22.88730935577185, 0 },
			{ -43.12465425307673, -22.88728681855343, 0 },
			{ -43.12465830928818, -22.88727680351019, 0 },
			{ -43.12466240731228, -22.88725588091793, 0 },
			{ -43.12466661911061, -22.8872411261676, 0 },
			{ -43.1246687800738, -22.88722619442775, 0 },
			{ -43.12467754432522, -22.88720285296107, 0 },
			{ -43.12467992172193, -22.88718315269853, 0 },
			{ -43.12468235185302, -22.88716361857307, 0 },
			{ -43.12468710109965, -22.88714380528931, 0 },
			{ -43.12469197402184, -22.88712347600027, 0 },
			{ -43.12469449743256, -22.88711103260509, 0 },
			{ -43.1246995723735, -22.8870898350076, 0 },
			{ -43.12470251447099, -22.88706371942719, 0 },
			{ -43.12470533043502, -22.88704581626993, 0 },
			{ -43.12470555312256, -22.88703674638475, 0 },
			{ -43.12470869322759, -22.88700887309333, 0 },
			{ -43.12471180651284, -22.88698491421706, 0 },
			{ -43.12471207405023, -22.88697516548605, 0 } };
}